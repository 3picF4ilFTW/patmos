#! /bin/bash

function usage() {
    echo "Usage: $0 [-I <file>] [-O <file>] [-a <file>|-x <file>] <file>"
}

function error_exit
{
	echo "$1" 1>&2
	exit -1
}

if [ -z "$PATMOS_HOME" ]; then
    PATMOS_HOME=@PATMOS_HOME@
fi
if [ -z "$COM_PORT" ]; then
    COM_PORT=@COM_PORT@
fi
if [ -z "$TIMEOUT" ]; then
    TIMEOUT=300
fi

CONFIG=Make
CONFIGFILE=

INFILE="/dev/stdin"
OUTFILE="/dev/stdout"

# Parse options
while getopts "hI:O:a:x:" arg; do
    case $arg in
        I)
            INFILE=$OPTARG
            ;;
        O)
            OUTFILE=$OPTARG
            ;;
        a)
            CONFIG=Altera
            CONFIGFILE=$OPTARG
            ;;
        x)
            CONFIG=Xilinx
            CONFIGFILE=$OPTARG
            ;;
        h)
            usage
            echo ""
            echo "-a <file> specifies a .cdf file to use for configuration of Altera FPGA"
            echo "-x <file> specifies a .bit file to use for configuration of Xilinx FPGA"
            echo "Without either '-a' or '-x', the FPGA is configured by calling"
            echo "'make config' in the directory specified in environment variable"
            echo "PATMOS_HOME."
            echo ""
            echo "The environment variable COM_PORT sets the serial port for downloading."
            echo "The environment variable TIMEOUT sets a timeout in seconds (default: 300)"
            exit 0
            ;;
        *)
            usage
            exit 1
            ;;
    esac
done

# Check argument count
shift $((OPTIND-1))
if [ $# -ne 1 ]; then
    usage
    exit 1
fi

# Configure FPGA
case $CONFIG in
    Altera)
        config_altera $CONFIGFILE
        ;;
    Xilinx)
        config_xilinx $CONFIGFILE
        ;;
    Make)
        make -C $PATMOS_HOME config
        ;;
esac &> /dev/null || error_exit "FPGA configuration failed"

# Download program to FPGA
BASEDIR=$(cd $(dirname "$0")/..; pwd)
timeout --foreground $TIMEOUT \
    java -Dverbose=false -cp $BASEDIR/lib/java/\* patserdow.Main $COM_PORT $1 \
    < $INFILE > $OUTFILE
